<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DashBoard</title>
    <link rel="stylesheet" href="./css/navbar.css">
    <link rel="stylesheet" href="./css/dashboards.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="obterDadosGrafico()"> <!-- Chamando a função obterDados ao carregar a página -->
    <nav class="navbar-dash">
        <div class="logo">Composição</div>
        <ul class="nav-links">
            <li> <a href="home.html">Home</a> </li>
            <li> <a href="beneficos.html">Beneficios</a> </li>
            <li> <a href="contribuicao.html">Contribuição</a> </li>
            <li> <a href="videos.html">Videos</a> </li>
        </ul>
        <div class="auth-links">
            <a href="login.html" class="button-login">Login</a>
            <a href="cadastro.html" class="button-cadastro">Cadastro</a>
        </div>
    </nav>

     Elemento canvas onde o gráfico de linha será desenhado 
    <canvas id="linha"></canvas>
    <canvas id="barra"></canvas>
    Elemento canvas onde o gráfico de barra será desenhado 


    <div class="englobaTudo">

        <!-- Cards Kpi's-->

        
      <!--  <div class="button-nav_dash">
            <button class="button-chart" onclick="exibirAcertosPorTopico(event)">Acertos por tópico </button>
            <button class="button-chart" onclick="exibirPreferenciasMusicais(event)">Preferencias Musicais </button>
            <button class="button-chart" onclick="exibirProgressoAprendizado(event)">Progresso Aprendizado </button>
        </div> -->

        

        <div class="graficos">
            <h2 class="tituloGrafico" id="titulo_grafico">Acertos por Tópico</h2>

            <div id="divAcertosTopico" class="display-block">
              
            </div>


            <div id="divPreferenciasMusicais" class="display-none">
                <canvas id="preferencias_musicais"></canvas>
            </div>

            <div id="divProgressoAprendizado" class="display-none">
                <canvas id="progresso_aprendizado"></canvas>
            </div>

        </div>

        <div class="cards">

            <div class="card-kpis">
                <h1 class="titulo">Taxa de Acerto</h1>

                <div class="descricao">
                    <p class="taxa_acertos">85%</p>
                </div>

                <div class="corCardAlerta" id="cardTaxaAcertos"></div>
            </div>

            <div class="card-kpis">
                <h1 class="titulo">Tempo Médio</h1>

                <div class="descricao">
                    <p class="tempo_medio">45s</p>
                </div>

                <div class="corCardAlerta" id="cardTempoMedio"></div>
            </div>


            <div class="card-kpis">
                <h1 class="titulo">Total Participantes</h1>

                <div class="descricao">
                    <p class="total_participantes">20</p>
                </div>

                <div class="corCardAlerta" id="cardTotalParticipantes"></div>
            </div>


            <div class="card-kpis">
                <h1 class="titulo">Engajamento</h1>

                <div class="descricao">
                    <p class="total_participantes">72%</p>
                </div>

                <div class="corCardAlerta" id="cardEngajamento"></div>
            </div>

        </div>






    </div>

</body>
<script>
    let chartAcertosTopico;
    let chartPreferenciasMusicais;
    let chartProgressoAprendizado;
    

    const dadosSimulados = {
    acertosPorTopico:[
        {topico: 'teoria musical', acertos: 80},
        {topico: 'composiçao', acertos: 60},
        {topico: 'leitura', acertos: 90} 
    ],
    preferenciasMusicais: [
        {genero: 'Rock', preferencia: 40},
        {genero: 'Classico', preferencia: 10},
        {genero: 'Eletronica', preferencia: 10},
        {genero: 'Pop', preferencia: 40}
    ],
    progress: [
        {semana: 'semana 1', taxa: 50},
        {semana: 'semana 2', taxa: 65},
        {semana: 'semana 3', taxa: 75},
        {semana: 'semana 4', taxa: 85}
    ]



}
/*
     // Função chamada ao carregar a página para obter e processar os dados
    function obterDados() {

        document.querySelector('.taxa_acertos').textContent = "75%"
        document.querySelector('.tempo_medio').textContent = "45s"
        document.querySelector('.total_participantes').textContent = "128"

        plotarGraficoAcertosPorTopico(dadosSimulados.acertosPorTopico)
         // Aqui seria a função que obteria os dados do banco de dados
         // No caso, aqui você colocaria o fetch que teria o endereço da sua rota que você criou na pasta /routes e chamaria a função plotarGraficoLinha nessa função. Exemplo:
 
          fetch('/obterDados')
          .then(function(response){
            return response.json();
          })
          .then(function(data){
            plotarGraficoLinha(data);
            plotarGraficoBarra(data);
          })
          .catch(function(err){
            console.log(err);
          })
 

         // Chamando a função para plotar o gráfico de linha com os dados
         plotarGraficoLinha(dados);
         // Chamando a função para plotar o gráfico de barra com os dados
         plotarGraficoBarra(dados)
    }






    /*
    // Alternar entre botoes ativos
    function setActiveButton(activeButton) {
        document.querySelectorAll('.button-chart').forEach(btn => {
            btn.classList.remove('active')
        })
        activeButton.classList.add('active')
    }

    // Graficos de Acertos Por Tópicos
    function exibirAcertosPorTopico(event, dados) {
        setActiveButton(event.target)
        document.getElementById('divAcertosTopico').classList.remove('display-none')
        document.getElementById('divAcertosTopico').classList.add('display-block')

        document.getElementById('divPreferenciasMusicais').classList.remove('display-block')
        document.getElementById('divPreferenciasMusicais').classList.add('display-none')

        document.getElementById('divProgressoAprendizado').classList.remove('display-block')
        document.getElementById('divProgressoAprendizado').classList.add('display-none')



       /* const ctx = document.getElementById('acertos_topico').getContext('2d')
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dados.map(item => item.topico),
                datasets: [{
                    label: 'Taxa de Acertos (%)',
                    data: dados.map(item => item.acertos),
                    backgroundColor: '#7b1fa2'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        }) */

        /*plotarGraficoAcertosPorTopico(dadosSimulados.acertosPorTopico) */
    //}  
 /*
    // Função plotar Grafico Preferencias
    function exibirPreferenciasMusicais (event) {
        setActiveButton(event.target)


        document.getElementById('divAcertosTopico').classList.add('display-none')
        document.getElementById('divPreferenciasMusicais').classList.remove('display-none')
        document.getElementById('divPreferenciasMusicais').classList.add('display-block')
        document.getElementById('divProgressoAprendizado').classList.add('display-none')



       /* const ctx = document.getElementById('preferencias_musicais').getContext('2d')
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: dados.map(item => item.genero),
                datasets: [{
                    label: 'Preferências (%)',
                    data: dados.map(item => item.preferencia),
                    backgroundColor: [
                        '#42a5f5', '#ab47bc', '#26a69a', '#aff725', '#ef5350'
                    ]
                }]
            },
            options: {
                responsive: true
            }
        })
        plotarGraficoPreferenciasMusicais(dadosSimulados.preferenciasMusicais)
    }


    // Função Plotar Progresso de Aprendizado 
    function exibirProgressoAprendizado(event, dados) {
        setActiveButton(event.target)

        
        document.getElementById('divAcertosTopico').classList.add('display-none')
        document.getElementById('divPreferenciasMusicais').classList.add('display-none')
        document.getElementById('divProgressoAprendizado').classList.remove('display-none')
        document.getElementById('divProgressoAprendizado').classList.add('display-block')



        const ctx = document.getElementById('progresso_aprendizado').getContext('2d')
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dados.map(item => item.semana),
                datasets: [{
                    label: 'Taxa de Aprendizado (%)',
                    data: dados.map(item => item.taxa),
                    borderColor: '#43a047',
                    backgroundColor: 'rgba(67, 160, 71, 0.2)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        })
            
      //  exibirProgressoAprendizado(dadosSimulados.progress)
    }*/

function obterDadosGrafico() {
    
    

    fetch(`/quiz/erradas`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                
                if(!resposta ||  resposta.length === 0){
                    console.warn("Nenhum dado Recebido")
                    return;
                }

                resposta.reverse()    //mais recente pro mais antigo 

                erradas(resposta)
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
        }
    })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });   
        }
    
    
    
    
    
    /* fetch(`/quiz/erradas`, { cache: 'no-store' })
        .then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse()
                    ;

                    erradas(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }*/
    
   /* function erradas(resposta) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: '',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.nome);
            dados.datasets[0].data.push(registro.quantidade);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`acertos_topico`),
            config
        );

        }*/


        //chatgpt

       function erradas(resposta) {
    console.log('iniciando plotagem do gráfico...');

    // Destruir gráfico anterior se existir
    if (chartAcertosTopico) {
        chartAcertosTopico.destroy();
    }
    // Vê se tem dados
    if(!resposta || resposta.length === 0){
        console.log("Nenhum dado recebido");
        return
    }

/*    const labels = [];
    const valores = [];*/

    // Prepara arrays para labels e dados
    const labels = resposta.map(item => item.nome)
    const valores = resposta.map(item => item.quantidade)



   /* // Processando os dados
    for (let i = 0; i < resposta.length; i++) {
        labels.push(resposta[i].nome);
        valores.push(resposta[i].quantidade);
    }*/


    // Tornar a div visível (apenas uma vez)
  /*  document.getElementById('divAcertosTopico').classList.remove('display-none');
    document.getElementById('divAcertosTopico').classList.add('display-block');*/

    const divGrafico = document.getElementById('divAcertosTopico')


    setTimeout(() => {
        divGrafico.innerHTML = '<canvas id="acertos_topico"></canvas>'   // Recria se necessario    

    const ctx = document.getElementById('acertos_topico').getContext('2d')

       chartAcertosTopico = new Chart( ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: "Quantidade de Erros",
                data: valores,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    }
                }
            }
        }
       }) 
    }, 10)
    
 

    // Configuração do gráfico
   /* const config = {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Quantidade de Erros',
                data: valores,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0 // Para mostrar apenas números inteiros
                    }
                }
            }
        }
    }; */

   /* // Criar e armazenar a instância do gráfico
    chartAcertosTopico = new Chart(
        document.getElementById('acertos_topico'),
        config
    );*/
}

</script>
</script>

</html>